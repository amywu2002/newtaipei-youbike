<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>æ–°åŒ— YouBike ç«™é»åœ°åœ–</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

#map {
  height: 100vh;
  width: 100%;
}

/* å·¦ä¸Šè§’ç«™é»æ•¸ */
#count {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 1000;
  background: #fff;
  padding: 6px 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
  font-size: 14px;
}

/* ä¸Šæ–¹æ§åˆ¶åˆ— */
#controls {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  display: flex;
  gap: 8px;
}

#controls input,
#controls select {
  padding: 8px 10px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

/* Marker é¡è‰² */
.marker.green  { --c:#7AC943; }
.marker.yellow { --c:#F5A623; }
.marker.red    { --c:#A80000; }

.leaflet-div-icon {
  background: transparent !important;
  border: none !important;
}

.marker svg {
  width: 60px;
  height: 68px;
}

/* Zoom æŒ‰éˆ•å³ä¸Š */
.leaflet-top.leaflet-left {
  right: 12px;
  left: auto;
}

/* ä½¿ç”¨è€…å®šä½è—é» */
.user-dot {
  width: 18px;
  height: 18px;
  background: #1A73E8;
  border-radius: 50%;
  border: 3px solid #fff;
  box-shadow: 0 0 10px rgba(0,0,0,.45);
}
</style>
</head>

<body>

<div id="count">ç«™é»ï¼š--</div>

<div id="controls">
  <input id="search" placeholder="æœå°‹ç«™é»åç¨±æˆ–åœ°å€â€¦" />
  <select id="statusFilter">
    <option value="all">å…¨éƒ¨</option>
    <option value="green">æ­£å¸¸</option>
    <option value="yellow">ç„¡è»Š</option>
    <option value="red">ç„¡ä½</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ğŸ”¥ æ–°åŒ— YouBike APIï¼ˆå·²åŒ… CORS proxyï¼‰ */
const NTPC_API =
  "https://api.allorigins.win/raw?url=https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json";

/* åœ°åœ–åˆå§‹åŒ– */
const map = L.map("map").setView([25.01, 121.46], 12);
map.zoomControl.setPosition("topright");

map.createPane("userLocation");
map.getPane("userLocation").style.zIndex = 650;

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

let data = [];
let markers = [];
let userMarker = null;

/* ä½¿ç”¨è€…å®šä½ */
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    userMarker = L.marker([latitude, longitude], {
      pane: "userLocation",
      icon: L.divIcon({
        className: "",
        html: `<div class="user-dot"></div>`,
        iconSize: [24, 24]
      })
    }).addTo(map);
    map.setView([latitude, longitude], 14);
  });
}

/* å·¥å…·å‡½å¼ */
function getStatus(b, r) {
  if (r === 0) return "red";
  if (b === 0) return "yellow";
  return "green";
}

function makeMarkerHTML(b, r, status) {
  return `
  <div class="marker ${status}">
    <svg viewBox="0 0 64 72">
      <path d="M32 2 C20 2 10 12 10 26
               C10 44 32 68 32 68
               C32 68 54 44 54 26
               C54 12 44 2 32 2Z"
        fill="var(--c)" stroke="#fff" stroke-width="3"/>
      <text x="32" y="26" text-anchor="middle"
        font-size="16" font-weight="700" fill="#fff">${b}</text>
      <text x="32" y="48" text-anchor="middle"
        font-size="16" font-weight="600" fill="#fff">${r}</text>
    </svg>
  </div>`;
}

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

/* Render */
function render() {
  clearMarkers();

  const kw = search.value.trim();
  const statusF = statusFilter.value;

  const list = data.filter(s => {
    const st = getStatus(s.borrow, s.ret);
    if (statusF !== "all" && st !== statusF) return false;
    if (kw && !s.name.includes(kw) && !s.addr.includes(kw)) return false;
    return true;
  });

  list.forEach(s => {
    const marker = L.marker([s.lat, s.lng], {
      icon: L.divIcon({
        iconSize: [60, 68],
        iconAnchor: [30, 68],
        html: makeMarkerHTML(s.borrow, s.ret, getStatus(s.borrow, s.ret))
      })
    }).addTo(map)
      .bindPopup(`
        <b>${s.name}</b><br>
        åœ°å€ï¼š${s.addr}<br>
        å¯å€Ÿï¼š${s.borrow}<br>
        å¯é‚„ï¼š${s.ret}
      `);

    markers.push(marker);
  });

  count.textContent = `ç«™é»ï¼š${markers.length}ç«™`;
}

/* è¼‰å…¥æ–°åŒ—è³‡æ–™ */
fetch(NTPC_API)
  .then(r => r.json())
  .then(j => {
    data = j.map(s => ({
      name: s.sna,
      addr: s.ar || "",
      lat: Number(s.lat),
      lng: Number(s.lng),
      borrow: Number(s.sbi),
      ret: Number(s.bemp)
    }));
    render();
  })
  .catch(err => {
    console.error("è³‡æ–™è¼‰å…¥å¤±æ•—", err);
    alert("æ–°åŒ— YouBike è³‡æ–™è¼‰å…¥å¤±æ•—");
  });

search.addEventListener("input", render);
statusFilter.addEventListener("change", render);
</script>

</body>
</html>
