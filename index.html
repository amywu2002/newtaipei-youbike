<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>Êñ∞Âåó YouBike Á´ôÈªûÂú∞Âúñ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
body { margin:0; font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
#map { height:100vh; width:100%; }

#count {
  position:absolute; top:12px; left:12px; z-index:1000;
  background:#fff; padding:6px 10px;
  border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,.15);
}

#controls {
  position:absolute; top:12px; left:50%;
  transform:translateX(-50%);
  z-index:1000; display:flex; gap:8px;
}

#controls input,#controls select {
  padding:8px 10px; border-radius:8px;
  border:1px solid #ccc; box-shadow:0 2px 6px rgba(0,0,0,.15);
}

.marker.green{--c:#7AC943;}
.marker.yellow{--c:#F5A623;}
.marker.red{--c:#A80000;}

.leaflet-div-icon{background:transparent!important;border:none!important;}
.marker svg{width:60px;height:68px;}
.leaflet-top.leaflet-left{right:12px;left:auto;}

.user-dot{
  width:18px;height:18px;background:#1A73E8;
  border-radius:50%;border:3px solid #fff;
}
</style>
</head>

<body>

<div id="count">Á´ôÈªûÔºö--</div>

<div id="controls">
  <input id="search" placeholder="ÊêúÂ∞ãÁ´ôÈªûÂêçÁ®±ÊàñÂú∞ÂùÄ‚Ä¶" />
  <select id="statusFilter">
    <option value="all">ÂÖ®ÈÉ®</option>
    <option value="green">Ê≠£Â∏∏</option>
    <option value="yellow">ÁÑ°Ëªä</option>
    <option value="red">ÁÑ°‰Ωç</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* üî• Êñ∞Âåó APIÔºàÂê´ CORS + ÂÖ®ÈÉ®Ë≥áÊñôÔºâ */
const NTPC_API =
  "https://api.allorigins.win/raw?url=" +
  encodeURIComponent(
    "https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json?limit=10000"
  );

const map = L.map("map").setView([25.01,121.46],12);
map.zoomControl.setPosition("topright");

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let data=[], markers=[];

/* ÁãÄÊÖã */
const getStatus=(b,r)=>r===0?"red":b===0?"yellow":"green";

const markerHTML=(b,r,s)=>`
<div class="marker ${s}">
<svg viewBox="0 0 64 72">
<path d="M32 2C20 2 10 12 10 26C10 44 32 68 32 68C32 68 54 44 54 26C54 12 44 2 32 2Z"
 fill="var(--c)" stroke="#fff" stroke-width="3"/>
<text x="32" y="26" text-anchor="middle" fill="#fff">${b}</text>
<text x="32" y="48" text-anchor="middle" fill="#fff">${r}</text>
</svg>
</div>`;

function render(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  const kw=search.value.trim();
  const f=statusFilter.value;

  data.filter(s=>{
    const st=getStatus(s.borrow,s.ret);
    if(f!=="all"&&st!==f) return false;
    if(kw&&!s.name.includes(kw)&&!s.addr.includes(kw)) return false;
    return true;
  }).forEach(s=>{
    const m=L.marker([s.lat,s.lng],{
      icon:L.divIcon({
        iconSize:[60,68],
        iconAnchor:[30,68],
        html:markerHTML(s.borrow,s.ret,getStatus(s.borrow,s.ret))
      })
    }).addTo(map)
    .bindPopup(`<b>${s.name}</b><br>${s.addr}<br>ÂèØÂÄü:${s.borrow} ÂèØÈÇÑ:${s.ret}`);
    markers.push(m);
  });

  count.textContent=`Á´ôÈªûÔºö${markers.length}Á´ô`;
}

fetch(NTPC_API)
.then(r=>r.json())
.then(j=>{
  data=j.map(s=>({
    name:s.sna,
    addr:s.ar||"",
    lat:+s.lat,
    lng:+s.lng,
    borrow:Number(s.sbi)||0,
    ret:Number(s.bemp)||0
  }));
  render();
});
search.oninput=render;
statusFilter.onchange=render;
</script>

</body>
</html>
